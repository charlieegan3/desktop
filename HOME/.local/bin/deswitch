#!/usr/bin/env bash

# kill any exiting nags
if [[ "$(pgrep -f swaynag)" ]]; then
  pgrep -f swaynag | xargs kill -SIGINT
fi

# find the pid of the current window
pid="$(swaymsg -t get_tree | jq -r '.. | (.nodes? // empty)[] | select(.focused) | .pid')"

# find the app_id, if missing then not wayland
app_id="$(swaymsg -t get_tree | jq -r '.. | (.nodes? // empty)[] | select(.focused) | .app_id')"

# find the command used to start the app
command=$(cat /proc/$pid/cmdline | tr '\000' ' ')

# handle switch
if [[ "$app_id" == "null" ]]; then
  exec swaynag -d -t warning \
    -m "restart $pid in wayland? ($command)" \
    -b "yes" "bash -c 'kill -s SIGINT $pid && exec env DISPLAY= MOZ_ENABLE_WAYLAND=1 WAYLAND_DISPLAY=wayland-0 $command'"
else
  exec swaynag -d -t warning \
    -m "restart $pid in X? ($command)" \
    -b "yes" "bash -c 'kill -s SIGINT $pid && exec env WAYLAND_DISPLAY= $command'"
fi
